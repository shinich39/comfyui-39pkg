# comfyui-pkg39

This package has created for generate image from generated image and embedded workflow.  
Using this package requires a little understanding of javascript syntax.  

## Feature

- Select random node regardless of type.
- Fast save from "Preview Image" node.
- Load workflow from images in directory.
- Loop images in sequentially from directory.
- Manipulate loaded workflow from image.
- Repeat same process when generating image and add some details.
- Start batch process with exactly the same process.
- Edit mask on the preview image with mouse control.
- Play notification sound each queue.

## Node list

- Random
- Load image
- Command

## Usage

### Add nodes  
Add node > pkg39 > ...  
Search "39"

### Random node  
Create a new output when connect input.  
Shuffle the connections after starting queue.  

### Send to pkg39  
After generate image, click the "Send to pkg39" button in context menu of "Preview Image" node.  
The image copied to "/ComfyUI/pkg39_images" directory.  

### Load image  
Default dir_path value is absolute path to pkg39_images.  
You can edit mask on preview image.  
Spin the wheel to change brush size after mouse over the preview image.  
When image loaded, import nodes from image metadata then place at right side of Load image node.  
The node applied only one command node that was created first.
Load image node is removed after loaded by another load image.
Prevent duplicate load. (Load image > image generated by Load image > Load image > ...)
In auto queue mode, ignore ComfyUI errors. (Link error, ...)

### Command  
Commnad has default guide lines.  
You should create command node after create nodes to use.  
Copy and paste to command node and use it.  
You can test your code by changing index.  

- Full code of Hi-Res fix
```js
// Upscale settings
var VAE_ENCODE_NODE_ID = 2;
var SAVE_NODE_ID = 3;
var CKPT_NAME = null;
var SCALE_BY = 1.5;
var DENOISE = 0.5;
var STEPS = 30;
var CFG = 6;
var SAMPLER_NAME = "euler";
var SCHEDULER = "simple";

// Create "VAE Encode" node and connect input IMAGE of "Load image" node
// Create "Save Image" node and you can set options
var vaeEncode = findOneById(VAE_ENCODE_NODE_ID);
var save = findOneById(SAVE_NODE_ID);
var vaeDecode = findOneLast("VAE Decode");
var sampler = findOne("KSampler");
var ckpt = findOne("Load Checkpoint");
vaeEncode.connectInput("vae", ckpt);
save.connectInput("images", vaeDecode);
if (CKPT_NAME) { ckpt.setValue("ckpt_name", CKPT_NAME)  }

// new sampler inherit sampler values and links
var [newUpscaler, newSampler] = sampler.hires(SCALE_BY);
newSampler.setValue("sampler_name", SAMPLER_NAME);
newSampler.setValue("scheduler", SCHEDULER);
newSampler.setValue("denoise", DENOISE);
newSampler.setValue("cfg", CFG);
newSampler.setValue("steps", STEPS);

vaeEncode.connectOutput("LATENT", newUpscaler);

sampler.remove();
remove("Empty Latent Image");
remove("Preview Image");
remove("Save Image");

sound();
```

- Full code of inpaint
```js
// Inpaint settings
var VAE_ENCODE_NODE_ID = 601;
var SAVE_NODE_ID = 1297;
var DENOISE = 1;
var STEPS = 30;
var CFG = 6;

// Create "VAE Encdoe (for Inpainting)" node and connect input IMAGE and MASK of "Load image" node
// Create "Save Image" node and you can set options
var vaeEncode = findOneById(VAE_ENCODE_NODE_ID);
var save = findOneById(SAVE_NODE_ID);
var vaeDecode = findOneLast("VAE Decode");
var sampler = findOneLast("KSampler");
var ckpt = findOne("Load Checkpoint");
vaeEncode.connectInput("vae", ckpt);
vaeEncode.connectOutput("LATENT", sampler);
save.connectInput("images", vaeDecode);

sampler.setValue("denoise", DENOISE);
sampler.setValue("cfg", CFG);
sampler.setValue("steps", STEPS);

remove("Empty Latent Image");
remove("Preview Image");
remove("Save Image");
remove("Image Save");

find("Upscale Latent").forEach(e => {
  if (!e.hasConnectedOutput) { e.remove() };
});

find("KSampler").forEach(e => {
  if (!e.hasConnectedOutput) { e.remove() };
});

sound();
```

- Set loaded image to LATENT
```js
// If VAE encode node exists in image workflow
MAIN.connectOutput("IMAGE", findOne("VAE Encode"))
```

```js
// No exists VAE encode in image workflow
// Create VAE encode in original workflow and connect IMAGE - pixels
var vaeEncode = findOneById(1); // VAE Encode
vaeEncode.connectInput("VAE", findOne("Load Checkpoint"));
vaeEncode.connectOutput("LATENT", findOne("KSampler"));
```

- Remove all "Preview Image" nodes
```js
// case 1
remove("Preview Image");

// case 2
find("Preview Image").forEach(e => {
  if (e.isEnd) { e.remove() }
});
```

- Disable all "Preview Image" nodes
```js
// case 1
disable("Preview Image");

// case 2
find("Preview Image").forEach(e => {
  if (e.isEnd) { e.disable() }
});
```

- Remove all "Ksampler" nodes that does not connected output.
```js
find("KSampler").forEach(e => {
  if (!e.hasConnectedOutput) { e.remove() };
});
```

- Set specific checkpoint 
```js
// case 1
var ckpt = findOneById(1); // Load Checkpoint
ckpt.connectOutput("MODEL", findOneLast("KSampler"));
ckpt.connectOutput("CLIP", find("CLIPTextEncode"));
ckpt.connectOutput("VAE", find("VAE Decode"));

// case 2
var ckpt = findOneById(1); // Load Checkpoint
var ckpt_name = ckpt.getValue("ckpt_name");
find("Load Checkpoint").forEach(e => e.setValue("ckpt_name", ckpt_name));

// case 3
var ckpt1 = findOneById(1); // Load Checkpoint
var ckpt2 = findOne("Load Checkpoint");
ckpt1.replace(ckpt2);
ckpt2.remove();
```

- Stop after run 5 (In auto queue mode)  
```js
if (countQueues > 5) { stop(); }
```

- Stop the loop after 1 try (In auto queue mode)  
```js
if (countLoops >= 1) { stop(); }
```

- Play sound each queue after exceeed 5 queues
```js
if (countQueues > 5) { sound(); }
```

- Load next image
```js
next();
```

- Setting a callback when error occurred on the "Commnad" node
```js
error = (err) => {
  // code here...
}
```

## Update

- ...

## References

- [was-node-suite-comfyui](https://github.com/WASasquatch/was-node-suite-comfyui)
- [comfyui-prompt-reader-node](https://github.com/receyuki/comfyui-prompt-reader-node)
- [notification sound](https://pixabay.com/sound-effects/duck-quack-112941/)
- [ComfyUI-Custom-Scripts](https://github.com/pythongosssss/ComfyUI-Custom-Scripts)
- And default ComfyUI nodes...