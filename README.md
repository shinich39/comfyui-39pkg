# comfyui-pkg39

This package has created for generate image from generated image and embedded workflow.  
Using this package requires a little understanding of javascript syntax.  

## Features

- Select random node regardless of type.
- Fast save from "Preview Image" node.
- Load workflow from images in directory.
- Loop images in sequentially from directory.
- Manipulate loaded workflow from image.
- Repeat same process when generating image and add some details.
- Start batch process with exactly the same process.
- Edit mask on the preview image with mouse control.
- Play notification sound each queue.
- When you focus on load image node, you can control index with keyboard.
- Add bracket keybindings in textarea: (), {}, []

## Nodes

- Random
- Keybinding
- Load image
- Command

## Usage

### Add nodes  
Add node > pkg39 > ...  
Search "39"

### Send to pkg39  
After generate image, click the "Send to pkg39" button in context menu of "Preview Image" node.  
The image copied to "/ComfyUI/pkg39_images" directory.  

### Random node  
Create a new output when connect input.  
Shuffle the connections after starting the queue.  

### Keybinding node  
Create a Keybinding node.  
When bracket keybinding enabled and you type opening bracket in textarea, bracket has closed and cursor move to inside of brackets.  
If you selected text range, brackets enclose the text range.  

### Load image node  
Default dir_path value is absolute path to pkg39_images.  
You can edit mask on preview image.  
Spin the wheel to change brush size after mouse over the preview image.  
When image loaded, import nodes from image metadata then place at right side of "Load image" node.  
The node applied only one command node that was created first.  
Prevent duplicate load. (Load image > image generated by Load image > Load image > ...)  
In auto queue mode, ignore ComfyUI errors. (Link error, ...)  
Keybindings\(after select node\):  
- F5 or Ctrl + r: Reload images in directory.
- Arrows: Next, Previous image.

### Command node  
Commnad has default guide lines.  
You should create command node after create nodes to use.  
Copy and paste to command node and use it.  
You can test your code to change command node.  
The examples use only Comfy Core nodes but you can use installed custom nodes.  

- Full code of Hi-Res fix
```js
// Upscale options
var STEPS = 30;
var CFG = 8;
var SAMPLER_NAME = "euler";
var SCHEDULER = "simple";
var DENOISE = 0.5;
var SCALE_BY = 2;

var vaeEncode = create("VAEEncode");
var saveImage = create("SaveImage");
var vaeDecode = findOneLast("VAEDecode");
var sampler = findOne("KSampler");
var ckpt = findOne("Load Checkpoint");

remove("EmptyLatentImage");
remove("PreviewImage");
remove("SaveImage");

vaeEncode.connectInput("pixels", MAIN);
vaeEncode.connectInput("vae", ckpt);

saveImage.connectInput("images", vaeDecode);
saveImage.setValue("filename_prefix", IMAGE_NAME);

// new sampler inherit values and connections from sampler
var [newUpscaler, newSampler] = sampler.hires(SCALE_BY);
newSampler.setValue("seed", SEED); // random seed
newSampler.setValue("steps", STEPS);
newSampler.setValue("cfg", CFG);
newSampler.setValue("sampler_name", SAMPLER_NAME);
newSampler.setValue("scheduler", SCHEDULER);
newSampler.setValue("denoise", DENOISE);

newUpscaler.connectInput("samples", vaeEncode);

sampler.remove();
```

- Full code of inpaint
```js
// Inpaint options
var STEPS = 30;
var CFG = 8;
var SAMPLER_NAME = "euler";
var SCHEDULER = "normal";
var DENOISE = 0.8;

var vaeEncode = create("VAEEncode");
var setLatentNoiseMask = create("SetLatentNoiseMask");
var saveImage = create("SaveImage");
var ckpt = findOne("Load Checkpoint");
var vaeDecode = findOneLast("VAEDecode");
var sampler = findOneLast("KSampler");

remove("EmptyLatentImage");
remove("PreviewImage");
remove("SaveImage");
remove("LatentUpscale");
remove("VAEEncode");

vaeEncode.connectInput("pixels", MAIN);
vaeEncode.connectInput("vae", ckpt);

setLatentNoiseMask.connectInput("mask", MAIN);
setLatentNoiseMask.connectInput("samples", vaeEncode);

saveImage.connectInput("images", vaeDecode);
saveImage.setValue("filename_prefix", IMAGE_NAME);

sampler.connectInput("model", ckpt);
sampler.connectInput("latent", setLatentNoiseMask);
sampler.setValue("seed", SEED); // random seed
sampler.setValue("steps", STEPS);
sampler.setValue("cfg", CFG);
// sampler.setValue("sampler_name", SAMPLER_NAME);
sampler.setValue("scheduler", SCHEDULER);
sampler.setValue("denoise", DENOISE);
```

- Connect LATENT output of "Load image" node in each image workflow
```js
// case 1
// image generated from Empty Latent Image node
if (findOne("EmptyLatentImage")) {
  var latentNode = findOne("EmptyLatentImage").getOutputNode("LATENT");
  MAIN.encode().connectOutput("LATENT", latentNode);
}
```

```js
// case 2
// image generated from Load Image node
if (findOne("LoadImage")) {
  var vaeEncode = findOne("LoadImage").getOutputNode("IMAGE");
  MAIN.connectOutput("IMAGE", vaeEncode);
}
```

```js
// case 3
// Create VAE Encode in workflow and connect IMAGE output with pixels input
var vaeEncode = findOneById(1); // VAE Encode
vaeEncode.connectInput("VAE", findOne("Load Checkpoint"));
vaeEncode.connectOutput("LATENT", findOne("KSampler"));
```

- Remove all "Preview Image" nodes
```js
// case 1
remove("PreviewImage");

// case 2
find("PreviewImage").forEach(e => {
  if (e.isEnd) { e.remove() }
});
```

- Disable all "Preview Image" nodes
```js
// case 1
disable("PreviewImage");

// case 2
find("PreviewImage").forEach(e => {
  if (e.isEnd) { e.disable() }
});
```

- Remove all "Ksampler" nodes that does not connected output.
```js
find("KSampler").forEach(e => {
  if (!e.hasConnectedOutput) { e.remove() };
});
```

- Set specific checkpoint 
```js
// case 1
var ckpt_name = "CHECKPOINT.safetensor";
find("Load Checkpoint").forEach(e => e.setValues("ckpt_name", ckpt_name));

// case 2
var newCkpt = findOneById(1); // Load Checkpoint
var oldCkpt = findOne("Load Checkpoint");
oldCkpt.replace(newCkpt);
oldCkpt.remove();
```

- Change KSampler node
```js
var newSampler = findOneById(1); // KSampler
var oldSampler = findOneLast("KSampler");
oldSampler.replace(newSampler);
oldSampler.remove();
```

- Add save node
```js
var sampler = findOneLast("KSampler");
var vaeDecode = sampler.decode();
var save = vaeDecode.save();
save.setValue("filename_prefix", "pkg39");
```

- Add Hi-Res fix
```js
// The node can use hires method when it have LATENT output.
// Inherit values and connections if node type is KSampler.
var sampler = findOneLast("KSampler");
var [newUpscaler, newSampler] = sampler.hires(1.5);
```

- Stop after run 5 (In auto queue mode)  
```js
if (countQueues > 5) { stop(); }
```

- Stop the loop after 1 try (In auto queue mode)  
```js
if (countLoops >= 1) { stop(); }
```

- Play sound each queue after exceeed 5 queues
```js
if (countQueues > 5) { sound(); }
```

- Load next image
```js
next();
```

- Setting a callback when error occurred on the "Commnad" node
```js
error = (err) => {
  // code here...
}
```

## References

- [was-node-suite-comfyui](https://github.com/WASasquatch/was-node-suite-comfyui)
- [comfyui-prompt-reader-node](https://github.com/receyuki/comfyui-prompt-reader-node)
- [notification sound](https://pixabay.com/sound-effects/duck-quack-112941/)
- [ComfyUI-Custom-Scripts](https://github.com/pythongosssss/ComfyUI-Custom-Scripts)
- And default ComfyUI nodes...